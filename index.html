<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H.C. Dra. Abraldes</title>
    
    <!-- Scripts de Producción (Más livianos y rápidos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230EA5E9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3'%3E%3C/path%3E%3Cpath d='M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4'%3E%3C/path%3E%3Ccircle cx='20' cy='10' r='2'%3E%3C/circle%3E%3C/svg%3E" type="image/svg+xml">

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f9ff; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfBgsLgnDGkkE_u0ZhXJs8SCczP531dg4",
            authDomain: "pediapp-61b0c.firebaseapp.com",
            projectId: "pediapp-61b0c",
            storageBucket: "pediapp-61b0c.firebasestorage.app",
            messagingSenderId: "639384422144",
            appId: "1:639384422144:web:924e5fcbf41bb2d1cd15e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "historia-clinica-v1";

        enableIndexedDbPersistence(db).catch(() => {});

        window.firebaseData = { 
            auth, db, appId, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut,
            collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp 
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- Icon System ---
        const Icon = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" 
                 stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const User = (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>;
        const Plus = (p) => <Icon {...p}><path d="M5 12h14M12 5v14"/></Icon>;
        const Search = (p) => <Icon {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
        const Trash2 = (p) => <Icon {...p}><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/></Icon>;
        const Save = (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8M7 3v5h8"/></Icon>;
        const ArrowLeft = (p) => <Icon {...p}><path d="m12 19-7-7 7-7M19 12H5"/></Icon>;
        const LogOut = (p) => <Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></Icon>;
        const Baby = (p) => <Icon {...p}><path d="M9 12h.01M15 12h.01M10 16c.5.3 1.2.5 2 .5s1.5-.2 2-.5M19 6.3a9 9 0 0 1 1.8 3.9 2 2 0 0 1 0 3.6 9 9 0 0 1-17.6 0 2 2 0 0 1 0-3.6A9 9 0 0 1 12 3"/></Icon>;

        // --- Utilidades ---
        const calculateAge = (b) => {
            if(!b) return "";
            const t = new Date(), br = new Date(b);
            let y = t.getFullYear() - br.getFullYear(), m = t.getMonth() - br.getMonth(), d = t.getDate() - br.getDate();
            if(d<0){ m--; d += new Date(t.getFullYear(), t.getMonth(), 0).getDate(); }
            if(m<0){ y--; m += 12; }
            if(y>=1) return `${y}a, ${m}m`;
            if(m>=1) return `${m}m, ${d}d`;
            return `${d}d`;
        };

        // --- App Principal ---
        const App = () => {
            const { auth, db, appId, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp } = window.firebaseData;
            
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState("list");
            const [patients, setPatients] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [authForm, setAuthForm] = useState({email:'', pass:'', reg: false, err: ''});
            const [currentPatient, setCurrentPatient] = useState(null);

            useEffect(() => {
                return onAuthStateChanged(auth, u => { setUser(u); setLoading(false); });
            }, []);

            useEffect(() => {
                if(!user) return;
                const colPath = collection(db, 'artifacts', appId, 'users', user.uid, 'patients');
                return onSnapshot(colPath, s => {
                    setPatients(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => (b.updatedAt || 0) - (a.updatedAt || 0)));
                }, (err) => alert("Error de permisos: " + err.message));
            }, [user]);

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    if(authForm.reg) await createUserWithEmailAndPassword(auth, authForm.email, authForm.pass);
                    else await signInWithEmailAndPassword(auth, authForm.email, authForm.pass);
                } catch(err) { setAuthForm(p=>({...p, err: "Error: Email o contraseña incorrectos"})); }
                setLoading(false);
            };

            if(loading) return <div className="h-screen flex items-center justify-center text-sky-500 font-bold animate-pulse">Cargando PediApp...</div>;

            if(!user) return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-sm p-8 rounded-2xl shadow-xl border border-slate-100">
                        <div className="flex flex-col items-center mb-6">
                            <div className="bg-sky-50 p-4 rounded-full text-sky-500 mb-3"><Baby size={40}/></div>
                            <h1 className="text-2xl font-bold text-slate-800">PediApp</h1>
                            <p className="text-slate-400 text-xs text-center mt-1">Sincronización segura entre dispositivos</p>
                        </div>
                        {authForm.err && <div className="bg-rose-50 text-rose-600 p-2 text-xs rounded mb-4 text-center font-bold">{authForm.err}</div>}
                        <form onSubmit={handleAuth} className="space-y-4">
                            <input type="email" placeholder="Email" required className="w-full p-3 bg-slate-50 rounded-lg outline-none border border-transparent focus:border-sky-300 transition-all" value={authForm.email} onChange={e=>setAuthForm(p=>({...p, email:e.target.value}))}/>
                            <input type="password" placeholder="Contraseña" required className="w-full p-3 bg-slate-50 rounded-lg outline-none border border-transparent focus:border-sky-300 transition-all" value={authForm.pass} onChange={e=>setAuthForm(p=>({...p, pass:e.target.value}))}/>
                            <button className="w-full bg-sky-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-sky-100 active:scale-95 transition-transform">{authForm.reg ? 'Crear Cuenta' : 'Ingresar'}</button>
                        </form>
                        <button onClick={()=>setAuthForm(p=>({...p, reg:!p.reg, err:''}))} className="w-full text-xs text-slate-400 mt-4 font-bold hover:text-sky-500">{authForm.reg ? '¿Ya tienes cuenta? Ingresa' : '¿No tienes cuenta? Regístrate gratis'}</button>
                    </div>
                </div>
            );

            const filtered = patients.filter(p => `${p.lastName} ${p.firstName} ${p.dni}`.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative">
                    <header className="bg-white p-4 sticky top-0 z-20 border-b flex justify-between items-center">
                        <div className="flex items-center gap-2 text-sky-500"><Baby size={24}/><h1 className="font-bold text-slate-800 text-sm">H.C. Dra. Abraldes</h1></div>
                        <div className="flex gap-1">
                            {view === 'form' && <button onClick={()=>setView('list')} className="text-slate-400 p-2 active:bg-slate-50 rounded-full"><ArrowLeft size={20}/></button>}
                            <button onClick={()=>confirm('¿Cerrar sesión?') && signOut(auth)} className="text-slate-300 p-2 active:text-rose-400"><LogOut size={20}/></button>
                        </div>
                    </header>

                    <main className="p-4 flex-1 overflow-y-auto hide-scrollbar">
                        {view === 'list' ? (
                            <div className="space-y-4 animate-fade-in">
                                <div className="relative">
                                    <Search className="absolute left-3 top-3 text-slate-300" size={20}/>
                                    <input placeholder="Buscar por nombre o DNI..." className="w-full pl-10 pr-4 py-3 bg-slate-50 rounded-xl outline-none border border-transparent focus:bg-white focus:border-sky-200 transition-all" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/>
                                </div>
                                <button onClick={()=>{setCurrentPatient(null); setView('form');}} className="w-full bg-sky-500 text-white p-4 rounded-xl font-bold shadow-lg shadow-sky-100 flex justify-center gap-2 active:scale-95 transition-all"><Plus/> Nuevo Paciente</button>
                                <div className="space-y-2">
                                    {filtered.map(p => (
                                        <div key={p.id} onClick={()=>{setCurrentPatient(p); setView('form');}} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 active:bg-sky-50 transition-all flex justify-between items-center cursor-pointer">
                                            <div className="flex-1">
                                                <div className="font-bold text-slate-800">{p.lastName}, {p.firstName}</div>
                                                <div className="text-[10px] font-bold text-slate-400 flex gap-2"><span>DNI: {p.dni}</span><span className="text-sky-500 uppercase">{calculateAge(p.birthDate)}</span></div>
                                            </div>
                                            <button onClick={(e)=>{e.stopPropagation(); confirm('¿Eliminar paciente?') && deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'patients', p.id));}} className="text-slate-200 hover:text-rose-400 p-2 transition-colors"><Trash2 size={18}/></button>
                                        </div>
                                    ))}
                                    {filtered.length === 0 && <div className="text-center py-10 text-slate-300 text-xs">No se encontraron pacientes.</div>}
                                </div>
                            </div>
                        ) : (
                            <PatientForm patient={currentPatient} onCancel={()=>setView('list')} onSave={async (d)=>{
                                const col = collection(db, 'artifacts', appId, 'users', user.uid, 'patients');
                                const data = {...d, updatedAt: serverTimestamp()};
                                try {
                                    if(currentPatient) await updateDoc(doc(col, currentPatient.id), data);
                                    else await addDoc(col, {...data, createdAt: serverTimestamp()});
                                    setView('list');
                                } catch(e) { alert("Error al guardar: " + e.message); }
                            }}/>
                        )}
                    </main>
                    <footer className="p-3 bg-slate-50 text-[9px] text-center text-slate-400 font-bold uppercase tracking-widest border-t">PediApp v3.0 - Offline Ready</footer>
                </div>
            );
        };

        const PatientForm = ({patient, onCancel, onSave}) => {
            const [f, setF] = useState(patient || {firstName:'', lastName:'', dni:'', birthDate:'', phone:'', note:'', weight:'', height:'', pc:''});
            const [saving, setSaving] = useState(false);

            const submit = async (e) => {
                e.preventDefault();
                setSaving(true);
                await onSave(f);
                setSaving(false);
            };

            return (
                <form onSubmit={submit} className="space-y-4 animate-fade-in pb-10">
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                        <div className="grid grid-cols-2 gap-3">
                            <div><label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Apellido</label><input required placeholder="Ej: Perez" className="w-full p-2 bg-slate-50 rounded-lg outline-none border border-transparent focus:border-sky-200" value={f.lastName} onChange={e=>setF(p=>({...p, lastName:e.target.value}))}/></div>
                            <div><label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Nombre</label><input required placeholder="Ej: Juan" className="w-full p-2 bg-slate-50 rounded-lg outline-none border border-transparent focus:border-sky-200" value={f.firstName} onChange={e=>setF(p=>({...p, firstName:e.target.value}))}/></div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div><label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">DNI</label><input required type="number" placeholder="Ej: 45123..." className="w-full p-2 bg-slate-50 rounded-lg outline-none" value={f.dni} onChange={e=>setF(p=>({...p, dni:e.target.value}))}/></div>
                            <div><label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Nacimiento</label><input required type="date" className="w-full p-2 bg-slate-50 rounded-lg outline-none" value={f.birthDate} onChange={e=>setF(p=>({...p, birthDate:e.target.value}))}/></div>
                        </div>
                        <div><label className="text-[10px] font-bold text-slate-400 ml-1 uppercase">Teléfono</label><input type="tel" placeholder="Opcional" className="w-full p-2 bg-slate-50 rounded-lg outline-none" value={f.phone || ''} onChange={e=>setF(p=>({...p, phone:e.target.value}))}/></div>
                    </div>

                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <h3 className="text-xs font-bold text-sky-500 uppercase mb-3 tracking-wider">Antropometría Actual</h3>
                        <div className="grid grid-cols-3 gap-3">
                            <input type="number" step="0.01" placeholder="Kg" className="p-2 bg-slate-50 rounded-lg text-center outline-none" value={f.weight || ''} onChange={e=>setF(p=>({...p, weight:e.target.value}))}/>
                            <input type="number" step="0.1" placeholder="Cm" className="p-2 bg-slate-50 rounded-lg text-center outline-none" value={f.height || ''} onChange={e=>setF(p=>({...p, height:e.target.value}))}/>
                            <input type="number" step="0.1" placeholder="PC" className="p-2 bg-slate-50 rounded-lg text-center outline-none" value={f.pc || ''} onChange={e=>setF(p=>({...p, pc:e.target.value}))}/>
                        </div>
                    </div>

                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <label className="text-xs font-bold text-slate-400 mb-3 block uppercase tracking-wider">Evolución Médica</label>
                        <textarea placeholder="Escribe aquí las observaciones de la consulta..." className="w-full p-4 bg-slate-50 rounded-xl text-sm min-h-[180px] outline-none border border-transparent focus:border-sky-100" value={f.note} onChange={e=>setF(p=>({...p, note:e.target.value}))}></textarea>
                    </div>

                    <div className="flex gap-4 px-2">
                        <button type="button" onClick={onCancel} className="flex-1 p-4 font-bold text-slate-400 active:bg-slate-50 rounded-xl transition-all">Cerrar</button>
                        <button type="submit" disabled={saving} className="flex-2 bg-sky-500 text-white p-4 rounded-xl font-bold shadow-lg shadow-sky-100 flex justify-center gap-2 active:scale-95 transition-all disabled:opacity-50">
                            <Save size={20}/> {saving ? 'Guardando...' : 'Guardar Datos'}
                        </button>
                    </div>
                </form>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script>
        // Registro de Service Worker para carga rápida en Chromebook
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
                if (isSecure) {
                    navigator.serviceWorker.register("./sw.js")
                    .then(reg => console.log("SW: PediApp lista para carga rápida."))
                    .catch(e => console.warn("SW: No se pudo activar el modo rápido.", e));
                }
            });
        }
    </script>
</body>
</html>
