<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H.C. Dra. Abraldes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230EA5E9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3'%3E%3C/path%3E%3Cpath d='M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4'%3E%3C/path%3E%3Ccircle cx='20' cy='10' r='2'%3E%3C/circle%3E%3C/svg%3E" type="image/svg+xml">

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f9ff; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, enableIndexedDbPersistence, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables de entorno o fallback
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCfBgsLgnDGkkE_u0ZhXJs8SCczP531dg4",
            authDomain: "pediapp-61b0c.firebaseapp.com",
            projectId: "pediapp-61b0c",
            storageBucket: "pediapp-61b0c.firebasestorage.app",
            messagingSenderId: "639384422144",
            appId: "1:639384422144:web:924e5fcbf41bb2d1cd15e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : "historia-clinica-v1";

        enableIndexedDbPersistence(db).catch(() => {});

        window.firebaseData = { 
            auth, db, appId, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signOut, signInWithCustomToken, signInAnonymously,
            collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query 
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- Icon System ---
        const Icon = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" 
                 stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const User = (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>;
        const Plus = (p) => <Icon {...p}><path d="M5 12h14M12 5v14"/></Icon>;
        const Search = (p) => <Icon {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
        const Trash2 = (p) => <Icon {...p}><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/></Icon>;
        const Save = (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8M7 3v5h8"/></Icon>;
        const ArrowLeft = (p) => <Icon {...p}><path d="m12 19-7-7 7-7M19 12H5"/></Icon>;
        const LogOut = (p) => <Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></Icon>;
        const Baby = (p) => <Icon {...p}><path d="M9 12h.01M15 12h.01M10 16c.5.3 1.2.5 2 .5s1.5-.2 2-.5M19 6.3a9 9 0 0 1 1.8 3.9 2 2 0 0 1 0 3.6 9 9 0 0 1-17.6 0 2 2 0 0 1 0-3.6A9 9 0 0 1 12 3"/></Icon>;
        const Activity = (p) => <Icon {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></Icon>;
        const Stethoscope = (p) => <Icon {...p}><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></Icon>;
        const CheckCircle = (p) => <Icon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m22 4-10 10.01-3-3"/></Icon>;
        const AlertCircle = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></Icon>;
        const X = (p) => <Icon {...p}><path d="M18 6 6 18M6 6l12 12"/></Icon>;

        const calculateAge = (b) => {
            if(!b) return "";
            const t = new Date(), br = new Date(b);
            let y = t.getFullYear() - br.getFullYear(), m = t.getMonth() - br.getMonth(), d = t.getDate() - br.getDate();
            if(d<0){ m--; d += new Date(t.getFullYear(), t.getMonth(), 0).getDate(); }
            if(m<0){ y--; m += 12; }
            if(y>=1) return `${y}a, ${m}m`;
            if(m>=1) return `${m}m, ${d}d`;
            return `${d}d`;
        };

        const TagInput = ({ label, options = [], value = [], onChange, placeholder }) => {
            const [input, setInput] = useState("");
            const [isOpen, setIsOpen] = useState(false);
            const handleAdd = (tag) => {
                if (tag.trim() && !value.includes(tag.trim())) onChange([...value, tag.trim()]);
                setInput(""); setIsOpen(false);
            };
            return (
                <div className="space-y-1 relative">
                    <label className="text-[10px] font-bold text-slate-400 uppercase ml-1">{label}</label>
                    <div className="flex flex-wrap gap-1 p-2 bg-slate-50 border rounded-lg min-h-[40px]">
                        {value.map(t => (
                            <span key={t} className="bg-sky-100 text-sky-700 text-[11px] px-2 py-1 rounded flex items-center gap-1">
                                {t} <button type="button" onClick={() => onChange(value.filter(x => x !== t))}><X size={12}/></button>
                            </span>
                        ))}
                        <input type="text" className="bg-transparent outline-none text-xs flex-1" placeholder={placeholder} value={input}
                               onChange={e => { setInput(e.target.value); setIsOpen(true); }} onFocus={() => setIsOpen(true)}/>
                    </div>
                    {isOpen && input && (
                        <div className="absolute z-30 w-full bg-white border shadow-lg rounded-lg mt-1 max-h-32 overflow-y-auto">
                            <div className="p-2 text-xs text-sky-600 font-bold border-b cursor-pointer" onMouseDown={() => handleAdd(input)}>Agregar "{input}"</div>
                            {options.filter(o => o.toLowerCase().includes(input.toLowerCase()) && !value.includes(o)).map(o => (
                                <div key={o} className="p-2 text-xs hover:bg-slate-50 cursor-pointer" onMouseDown={() => handleAdd(o)}>{o}</div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const { auth, db, appId, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInWithCustomToken, signInAnonymously, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query } = window.firebaseData;
            
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState("list");
            const [patients, setPatients] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [authForm, setAuthForm] = useState({email:'', pass:'', reg: false, err: ''});
            const [currentPatient, setCurrentPatient] = useState(null);
            const [errorMsg, setErrorMsg] = useState("");
            const fileInputRef = useRef(null);

            // (1) Auth Effect - Mandatory Pattern
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        }
                        // Dejamos que el usuario use email/password si ya lo tiene, 
                        // sino el listener onAuthStateChanged capturará el estado.
                    } catch (e) { console.error("Auth Error:", e); }
                };
                initAuth();
                return onAuthStateChanged(auth, u => { setUser(u); setLoading(false); });
            }, []);

            // (2) Data Fetching - Mandatory Pattern
            useEffect(() => {
                if(!user) {
                    setPatients([]);
                    return;
                }
                
                // RUTA CRÍTICA: artifacts/{appId}/users/{userId}/patients
                const colPath = collection(db, 'artifacts', appId, 'users', user.uid, 'patients');
                const q = query(colPath);

                const unsubscribe = onSnapshot(q, 
                    (s) => {
                        setPatients(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0)));
                        setErrorMsg("");
                    }, 
                    (err) => {
                        console.error("Firestore Error:", err);
                        if (err.code === 'permission-denied') {
                            setErrorMsg("ERROR DE PERMISOS: Debes actualizar las REGLAS en tu consola de Firebase Firestore.");
                        } else {
                            setErrorMsg("Error: " + err.message);
                        }
                    }
                );
                return () => unsubscribe();
            }, [user]);

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setAuthForm(p => ({...p, err:''}));
                try {
                    if(authForm.reg) await createUserWithEmailAndPassword(auth, authForm.email, authForm.pass);
                    else await signInWithEmailAndPassword(auth, authForm.email, authForm.pass);
                } catch(err) { setAuthForm(p=>({...p, err: "Email o contraseña incorrectos"})); }
                setLoading(false);
            };

            const handleSave = async (data) => {
                if (!user) return;
                setLoading(true);
                const col = collection(db, 'artifacts', appId, 'users', user.uid, 'patients');
                const toSave = {...data, updatedAt: serverTimestamp()};
                try {
                    if(currentPatient?.id) await updateDoc(doc(col, currentPatient.id), toSave);
                    else await addDoc(col, {...toSave, createdAt: serverTimestamp()});
                    setView("list");
                    setCurrentPatient(null);
                } catch(e) { 
                    alert(e.code === 'permission-denied' ? "Error: No tienes permiso para escribir. Revisa las Reglas de Firebase." : e.message);
                }
                setLoading(false);
            };

            const exportBackup = () => {
                const data = JSON.stringify(patients, null, 2);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pediapp-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };

            const importBackup = (e) => {
                const file = e.target.files[0];
                if (!file || !user) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        const col = collection(db, 'artifacts', appId, 'users', user.uid, 'patients');
                        for (const p of imported) {
                            const { id, ...cleanData } = p;
                            await addDoc(col, { ...cleanData, updatedAt: serverTimestamp() });
                        }
                        alert("Sincronización finalizada.");
                    } catch (err) { alert("Error al importar: " + err.message); }
                };
                reader.readAsText(file);
            };

            if(loading) return <div className="h-screen flex items-center justify-center text-sky-500 font-bold">Cargando...</div>;

            if(!user) return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-sm p-8 rounded-2xl shadow-xl border border-slate-100">
                        <div className="flex flex-col items-center mb-6">
                            <div className="bg-sky-50 p-4 rounded-full text-sky-500 mb-3"><Stethoscope size={40}/></div>
                            <h1 className="text-2xl font-bold text-slate-800">PediApp</h1>
                            <p className="text-slate-400 text-xs text-center mt-1">Tu cuenta para ver pacientes en cualquier lugar</p>
                        </div>
                        {authForm.err && <div className="bg-rose-50 text-rose-600 p-2 text-xs rounded mb-4 text-center font-bold">{authForm.err}</div>}
                        <form onSubmit={handleAuth} className="space-y-4">
                            <input type="email" placeholder="Email" required className="w-full p-3 bg-slate-50 rounded-lg outline-none border focus:border-sky-300" value={authForm.email} onChange={e=>setAuthForm(p=>({...p, email:e.target.value}))}/>
                            <input type="password" placeholder="Contraseña" required className="w-full p-3 bg-slate-50 rounded-lg outline-none border focus:border-sky-300" value={authForm.pass} onChange={e=>setAuthForm(p=>({...p, pass:e.target.value}))}/>
                            <button className="w-full bg-sky-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-sky-100">Ingresar</button>
                        </form>
                        <button onClick={()=>setAuthForm(p=>({...p, reg:!p.reg}))} className="w-full text-xs text-slate-400 mt-4 font-bold">{authForm.reg ? 'Ya tengo cuenta' : 'Crear cuenta nueva'}</button>
                    </div>
                </div>
            );

            const filtered = patients.filter(p => `${p.lastName} ${p.firstName} ${p.dni}`.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative">
                    <header className="bg-white p-4 sticky top-0 z-20 border-b flex justify-between items-center">
                        <div className="flex items-center gap-2 text-sky-500"><Baby size={24}/><h1 className="font-bold text-slate-800 text-sm">H.C. Dra. Abraldes</h1></div>
                        <div className="flex gap-1">
                            {view === 'form' && <button onClick={()=>setView('list')} className="text-slate-400 p-2"><ArrowLeft size={20}/></button>}
                            <button onClick={()=>confirm('¿Cerrar sesión?') && signOut(auth)} className="text-slate-300 p-2"><LogOut size={20}/></button>
                        </div>
                    </header>

                    <main className="p-4 flex-1 overflow-y-auto">
                        {errorMsg && (
                            <div className="bg-rose-50 border border-rose-200 text-rose-600 p-3 rounded-xl mb-4 text-xs font-bold flex gap-2">
                                <AlertCircle size={16} className="shrink-0"/> {errorMsg}
                            </div>
                        )}

                        {view === 'list' ? (
                            <div className="space-y-4 animate-fade-in">
                                <input placeholder="Buscar paciente o DNI..." className="w-full p-3 bg-slate-50 rounded-xl outline-none" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/>
                                <button onClick={()=>{setCurrentPatient(null); setView('form');}} className="w-full bg-sky-500 text-white p-4 rounded-xl font-bold shadow-lg shadow-sky-100 flex justify-center gap-2"><Plus/> Nuevo Paciente</button>
                                
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={exportBackup} className="text-[10px] font-bold bg-slate-50 text-slate-400 p-2 rounded-lg uppercase">⬇️ Exportar Backup</button>
                                    <button onClick={()=>fileInputRef.current.click()} className="text-[10px] font-bold bg-slate-50 text-slate-400 p-2 rounded-lg uppercase">⬆️ Importar Backup</button>
                                    <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={importBackup}/>
                                </div>

                                <div className="space-y-2">
                                    {filtered.map(p => (
                                        <div key={p.id} onClick={()=>{setCurrentPatient(p); setView('form');}} className="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center cursor-pointer active:bg-sky-50">
                                            <div>
                                                <div className="font-bold text-slate-800">{p.lastName}, {p.firstName}</div>
                                                <div className="text-[10px] font-bold text-slate-400 uppercase">DNI: {p.dni} | {calculateAge(p.birthDate)}</div>
                                            </div>
                                            <button onClick={(e)=>{e.stopPropagation(); confirm('¿Eliminar?') && deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'patients', p.id));}} className="text-rose-200 p-2"><Trash2 size={18}/></button>
                                        </div>
                                    ))}
                                    {patients.length > 0 && filtered.length === 0 && <p className="text-center text-slate-400 text-xs py-4">No se encontraron resultados.</p>}
                                    {patients.length === 0 && !errorMsg && <p className="text-center text-slate-400 text-xs py-10">Tu lista está vacía. Si tenías pacientes antes, usa el botón de "Importar Backup" una única vez.</p>}
                                </div>
                            </div>
                        ) : (
                            <PatientForm patient={currentPatient} onCancel={()=>setView('list')} onSave={handleSave}/>
                        )}
                    </main>
                </div>
            );
        };

        const PatientForm = ({patient, onCancel, onSave}) => {
            const [f, setF] = useState(patient || {
                firstName:'', lastName:'', dni:'', birthDate:'', phone:'',
                neonatal:[], pathological:[], pending:[], images:[], consults:[]
            });
            const [newCons, setNewCons] = useState({date: new Date().toISOString().split('T')[0], motive:[], weight:'', height:'', pc:'', note:''});
            const [newPend, setNewPend] = useState("");
            const [isSaving, setIsSaving] = useState(false);
            const camRef = useRef(null);

            const handleImage = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const r = new FileReader();
                r.onloadend = () => {
                    const img = new Image();
                    img.src = r.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const max = 800; let w = img.width, h = img.height;
                        if(w>max || h>max){ const scale = Math.min(max/w, max/h); w*=scale; h*=scale; }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        const b64 = canvas.toDataURL('image/jpeg', 0.7);
                        setF(p => ({...p, images:[...(p.images||[]), {id:Date.now(), src:b64, date:new Date().toLocaleDateString()}]}));
                    };
                };
                r.readAsDataURL(file);
            };

            const submit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                let consults = [...(f.consults || [])];
                if(newCons.note || newCons.weight || newCons.motive.length > 0) {
                    consults.push({...newCons, id:Date.now()});
                }
                await onSave({...f, consults: consults.sort((a,b)=>new Date(b.date)-new Date(a.date))});
                setIsSaving(false);
            };

            return (
                <form onSubmit={submit} className="space-y-5 animate-fade-in pb-10">
                    {/* Ficha Personal */}
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                        <div className="flex items-center gap-2 text-sky-600 font-bold mb-2"><User size={18}/> Ficha Personal</div>
                        <div className="grid grid-cols-2 gap-3">
                            <input required placeholder="Apellido" className="w-full p-2 bg-slate-50 rounded-lg outline-none" value={f.lastName} onChange={e=>setF(p=>({...p, lastName:e.target.value}))}/>
                            <input required placeholder="Nombre" className="w-full p-2 bg-slate-50 rounded-lg outline-none" value={f.firstName} onChange={e=>setF(p=>({...p, firstName:e.target.value}))}/>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <input required type="number" placeholder="DNI" className="w-full p-2 bg-slate-50 rounded-lg outline-none" value={f.dni} onChange={e=>setF(p=>({...p, dni:e.target.value}))}/>
                            <input required type="date" className="w-full p-2 bg-slate-50 rounded-lg outline-none" value={f.birthDate} onChange={e=>setF(p=>({...p, birthDate:e.target.value}))}/>
                        </div>
                        <input placeholder="Teléfono" className="w-full p-2 bg-slate-50 rounded-lg outline-none" value={f.phone} onChange={e=>setF(p=>({...p, phone:e.target.value}))}/>
                    </div>

                    {/* Antecedentes */}
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-3">
                        <div className="flex items-center gap-2 text-sky-600 font-bold mb-2"><Activity size={18}/> Antecedentes</div>
                        <TagInput label="Neonatales" options={["Sano", "Prematuro", "Ictericia", "ARM"]} value={f.neonatal} onChange={v => setF(p=>({...p, neonatal:v}))} placeholder="Agregar..."/>
                        <TagInput label="Patológicos" options={["Asma", "Alergia", "Bronquiolitis", "Celiaquía"]} value={f.pathological} onChange={v => setF(p=>({...p, pathological:v}))} placeholder="Agregar..."/>
                    </div>

                    {/* Consulta Actual */}
                    <div className="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-sky-500 space-y-4">
                        <div className="flex items-center gap-2 text-sky-600 font-bold mb-2"><Stethoscope size={18}/> Consulta Actual</div>
                        <div className="flex justify-between items-center">
                            <label className="text-xs font-bold text-slate-400 uppercase">Fecha</label>
                            <input type="date" className="p-1 border rounded text-xs" value={newCons.date} onChange={e=>setNewCons(p=>({...p, date:e.target.value}))}/>
                        </div>
                        <TagInput label="Motivo de Consulta" options={["Control", "Fiebre", "Tos", "Vacunas"]} value={newCons.motive} onChange={v => setNewCons(p=>({...p, motive:v}))} placeholder="Agregar motivo..."/>
                        <div className="grid grid-cols-3 gap-2">
                            <div><label className="text-[10px] font-bold text-slate-400 block ml-1 uppercase">Peso (Kg)</label><input type="number" step="0.01" className="w-full p-2 bg-slate-50 rounded-lg outline-none text-center" value={newCons.weight} onChange={e=>setNewCons(p=>({...p, weight:e.target.value}))}/></div>
                            <div><label className="text-[10px] font-bold text-slate-400 block ml-1 uppercase">Talla (Cm)</label><input type="number" step="0.1" className="w-full p-2 bg-slate-50 rounded-lg outline-none text-center" value={newCons.height} onChange={e=>setNewCons(p=>({...p, height:e.target.value}))}/></div>
                            <div><label className="text-[10px] font-bold text-slate-400 block ml-1 uppercase">P.C. (Cm)</label><input type="number" step="0.1" className="w-full p-2 bg-slate-50 rounded-lg outline-none text-center" value={newCons.pc} onChange={e=>setNewCons(p=>({...p, pc:e.target.value}))}/></div>
                        </div>
                        <textarea placeholder="Evolución y notas de la consulta..." className="w-full p-3 bg-slate-50 rounded-xl text-sm min-h-[140px] outline-none" value={newCons.note} onChange={e=>setNewCons(p=>({...p, note:e.target.value}))}></textarea>
                    </div>

                    {/* Historial */}
                    {f.consults?.length > 0 && (
                        <div className="space-y-2">
                            <label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Historial Clínico</label>
                            {f.consults.map(c => (
                                <div key={c.id} className="bg-slate-50 p-4 rounded-xl text-xs space-y-1 border border-slate-100 shadow-sm">
                                    <div className="flex justify-between font-bold text-sky-600"><span>{c.date}</span><span>{c.weight}kg | {c.height}cm | PC: {c.pc}</span></div>
                                    <div className="font-bold text-slate-700">Motivo: {c.motive?.join(", ")}</div>
                                    <p className="text-slate-500 italic mt-1 leading-relaxed">{c.note}</p>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Pendientes */}
                    <div className="bg-amber-50 p-5 rounded-2xl shadow-sm border border-amber-100">
                        <div className="flex items-center gap-2 text-amber-700 font-bold mb-3"><AlertCircle size={18}/> Pendientes</div>
                        <div className="flex gap-2 mb-3">
                            <input className="flex-1 p-2 bg-white rounded-lg outline-none border border-amber-200 text-xs shadow-inner" placeholder="Escribir pendiente..." value={newPend} onChange={e=>setNewPend(e.target.value)}/>
                            <button type="button" onClick={()=>{ if(newPend){ setF(p=>({...p, pending:[...(p.pending||[]), {id:Date.now(), text:newPend}]})); setNewPend(""); } }} className="bg-amber-500 text-white p-2 rounded-lg shadow-md"><Plus size={16}/></button>
                        </div>
                        <div className="space-y-1">
                            {f.pending?.map(p => (
                                <div key={p.id} className="bg-white p-2 rounded-lg flex justify-between items-center border border-amber-100 text-xs">
                                    <span className="text-slate-700">{p.text}</span>
                                    <button type="button" onClick={()=>setF(prev=>({...prev, pending:prev.pending.filter(x=>x.id!==p.id)}))} className="text-emerald-500 hover:scale-110 transition-transform"><CheckCircle size={18}/></button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Imágenes */}
                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                        <div className="flex justify-between items-center mb-3">
                            <div className="font-bold text-slate-700 text-xs uppercase tracking-tight">Fotos / Estudios</div>
                            <button type="button" onClick={()=>camRef.current.click()} className="text-sky-500 font-bold text-xs bg-sky-50 px-2 py-1 rounded">+ Agregar</button>
                        </div>
                        <input type="file" ref={camRef} className="hidden" accept="image/*" onChange={handleImage}/>
                        <div className="grid grid-cols-4 gap-2">
                            {f.images?.map(img => (
                                <div key={img.id} className="aspect-square relative rounded-lg overflow-hidden border shadow-sm">
                                    <img src={img.src} className="w-full h-full object-cover"/>
                                    <button type="button" onClick={()=>setF(p=>({...p, images:p.images.filter(x=>x.id!==img.id)}))} className="absolute top-0 right-0 bg-white/90 p-1 text-rose-500 rounded-bl-lg"><Trash2 size={12}/></button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Botones */}
                    <div className="flex gap-4 sticky bottom-0 bg-white p-2 border-t">
                        <button type="button" onClick={onCancel} className="flex-1 p-4 font-bold text-slate-400">Cancelar</button>
                        <button type="submit" disabled={isSaving} className="flex-2 bg-sky-500 text-white p-4 rounded-xl font-bold shadow-lg shadow-sky-200 flex justify-center gap-2 active:scale-95 transition-all">
                            <Save size={20}/> {isSaving ? 'Guardando...' : 'Guardar Paciente'}
                        </button>
                    </div>
                </form>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
